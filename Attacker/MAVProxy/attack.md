# MAVProxy Attack Module 说明文档

本文档详细说明了 attack.py 模块可以实现的各种攻击方式及其实现原理。

## 模块加载方式

可以通过以下几种方式加载攻击模块：

```bash
# QGC地面站
--master 127.0.0.1:14550 --out 127.0.0.1:14551 --cmd="module load attack"

# Gazebo仿真
--master=tcpin:127.0.0.1:4561 --out=tcp:127.0.0.1:4560 --cmd="module load attack"

# MAVROS
--master 127.0.0.1:24540 --out 127.0.0.1:24541 --cmd="module load attack"
```

## MAVProxy 端口配置与数据流向

### 启动命令说明

```bash
python mavproxy.py --master=tcpin:127.0.0.1:4561 --out=tcp:127.0.0.1:4560 --cmd='module load attack'
```

### 数据流向图

```
PX4 (SITL)      MAVProxy        Ground Control Station (QGC)
[Port 4561] <---> [MAVProxy] <---> [Port 4560]
```

### 端口配置详解

1. **输入端口 (--master)**：
   - 端口号：4561
   - 连接方式：tcpin
   - 目标：PX4 SITL 模拟器
   - 功能：接收来自飞控的 MAVLink 消息

2. **输出端口 (--out)**：
   - 端口号：4560
   - 连接方式：tcp
   - 目标：地面站（QGroundControl）
   - 功能：转发处理后的消息到地面站

### 数据流向过程

1. **飞控到地面站**：
   ```
   PX4 (4561) -> process_mavlink() -> 模块处理 -> 地面站 (4560)
   ```
   - 数据从 PX4 发出
   - 经过 process_mavlink 函数处理
   - 通过 mavlink_backward 函数进行模块处理
   - 最终发送到地面站

2. **地面站到飞控**：
   ```
   地面站 (4560) -> process_master() -> 模块处理 -> PX4 (4561)
   ```
   - 数据从地面站发出
   - 经过 process_master 函数处理
   - 通过 mavlink_packet 函数进行模块处理
   - 最终发送到 PX4

### Attack 模块介入点

1. **mavlink_backward 函数**：
   - 处理从飞控到地面站的数据
   - 可以修改传感器数据
   - 可以实现 GPS 欺骗
   - 可以修改状态信息

2. **mavlink_packet 函数**：
   - 处理从地面站到飞控的数据
   - 可以修改控制命令
   - 可以实现硬件后门攻击
   - 可以修改任务指令

### 配置特点

1. **本地环回连接**：
   - 使用 127.0.0.1 作为本地环回地址
   - 所有通信在本地完成
   - 便于调试和测试

2. **中间人位置**：
   - MAVProxy 作为中间代理
   - 可以监听所有通信数据
   - 可以修改任意数据包
   - 实现双向通信控制

3. **模块化设计**：
   - 通过 --cmd 加载攻击模块
   - 支持动态启用/禁用攻击功能
   - 便于扩展新的攻击方式

## 攻击类型及实现

### 1. 硬件后门攻击 (Hardware Backdoor)

- **命令**: `attack hardware_backdoor on/off`
- **目标**: 执行器控制信号
- **实现方式**:
  - 拦截 `HIL_ACTUATOR_CONTROLS` 消息
  - 修改 controls[0] 值（增加0.9）
  - 影响飞行器的执行器控制
- **影响**: 可能导致飞行器失控或执行异常动作

### 2. 消息修改攻击 (Message Modification)

- **命令**: `attack message_modification`
- **目标**: 任务航点信息
- **实现方式**:
  - 拦截 `MISSION_ITEM_INT` 消息
  - 修改航点坐标（x和y各增加3000）
- **影响**: 导致飞行器执行错误的任务路径

### 3. 传感器修改攻击 (Sensor Modification)

- **命令**: `attack sensor_modification on/off   `
- **目标**: 传感器数据
- **实现方式**:
  - 拦截 `HIL_SENSOR` 消息
  - 修改传感器原始数据
- **影响**: 影响飞行器的状态估计和控制决策

### 4. 传感器注入攻击 (Sensor Injection)

- **命令**: `attack sensor_injection`
- **目标**: 传感器数据流
- **实现方式**:

  - 拦截 `HIL_SENSOR` 消息
  - 注入预设的虚假传感器数据

  ```python
  new_mav.hil_sensor_send(time_usec-1, 0.1, 0.1, 0.1, 0, 0, 0,
                         1, 1, 1, -3.94092e+29, 4.58141e-41,
                         -9.61733e-41, 4.58127e-36, 63, 0)
  ```
- **影响**: 使飞行器接收到完全错误的传感器信息

### 5. GPS欺骗攻击 (GPS Spoofing)

- **命令**: `attack gps on/off`
- **目标**: GPS定位信息
- **实现方式**:
  - 拦截 `HIL_GPS` 消息
  - 修改经纬度信息（各增加1000）
- **影响**: 导致飞行器定位错误，可能偏离预定航线

### 6. 地面站欺骗攻击 (GCS Spoofing)

- **命令**: `attack gcs on/off`
- **目标**: 地面站显示的位置信息
- **实现方式**:
  - 拦截 `GLOBAL_POSITION_INT` 消息
  - 修改显示的经纬度坐标
- **影响**: 误导地面站操作员对飞行器位置的判断

### 7. 速度反转攻击 (Velocity Reversal)

- **命令**: `attack reverse_velocity`
- **目标**: 飞行器速度控制
- **实现方式**:
  - 拦截 `SET_POSITION_TARGET_LOCAL_NED` 消息
  - 将vx和vy速度值取反
- **影响**: 导致飞行器朝与指令相反的方向运动

## Iris 无人机传感器配置

### 标准传感器配置表

| 传感器类型 | 数据消息类型 | 更新频率 | 测量范围 | 主要用途 | 可攻击参数 |
|-----------|------------|---------|---------|---------|------------|
| IMU (惯性测量单元) | `HIL_SENSOR` | 250Hz | - | 姿态估计 | - |
| - 加速度计 | - | 250Hz | ±16g | 加速度测量 | xacc, yacc, zacc |
| - 陀螺仪 | - | 250Hz | ±2000°/s | 角速度测量 | xgyro, ygyro, zgyro |
| - 磁力计 | - | 50Hz | ±4.8 Gauss | 航向测量 | xmag, ymag, zmag |
| 气压计 | `HIL_SENSOR` | 50Hz | 300-1100hPa | 高度测量 | pressure, pressure_alt |
| GPS | `HIL_GPS` | 10Hz | 全球范围 | 位置定位 | lat, lon, alt, vel |
| 光流传感器 | `OPTICAL_FLOW` | 50Hz | 高度<10m | 位置保持 | flow_x, flow_y, quality |
| 测距仪 | `DISTANCE_SENSOR` | 20Hz | 0.2-40m | 高度测量/避障 | current_distance |

### 传感器数据流

1. **IMU数据流**：
   ```
   传感器 -> HIL_SENSOR -> EKF -> 姿态估计
   ```

2. **GPS数据流**：
   ```
   传感器 -> HIL_GPS -> EKF -> 位置估计
   ```

3. **气压计数据流**：
   ```
   传感器 -> HIL_SENSOR -> EKF -> 高度估计
   ```

### 传感器特性说明

1. **IMU (惯性测量单元)**
   - 核心导航传感器
   - 包含三轴加速度计、陀螺仪和磁力计
   - 用于姿态估计和运动检测
   - 高频率数据更新

2. **GPS模块**
   - 提供全球位置信息
   - 包括经纬度和高度数据
   - 提供地面速度信息
   - 更新频率相对较低

3. **气压计**
   - 提供气压高度信息
   - 补充GPS高度数据
   - 用于垂直位置控制
   - 受温度和天气影响

4. **光流传感器**
   - 用于低空位置保持
   - 需要配合测距仪使用
   - 对光照条件敏感
   - 用于增强定点悬停能力

5. **测距仪**
   - 提供精确高度信息
   - 用于近地面操作
   - 辅助避障功能
   - 测量范围有限

### 传感器融合

在 PX4 中，这些传感器数据通过扩展卡尔曼滤波器(EKF)进行融合：

1. **姿态估计**：
   - 主要使用 IMU 数据
   - 磁力计用于航向修正
   - 更新频率 250Hz

2. **位置估计**：
   - GPS 提供全局位置
   - 气压计提供高度辅助
   - 光流提供局部位置
   - 更新频率 50Hz

3. **高度估计**：
   - 气压计提供主要高度信息
   - GPS 高度作为参考
   - 测距仪用于近地面精确测量
   - 更新频率 50Hz

## HIL_SENSOR 消息参数说明

### 时间戳参数
| 参数 | 类型 | 单位 | 说明 |
|------|------|------|------|
| time_usec | uint64_t | 微秒 | 时间戳，系统启动后的微秒数 |

### IMU 传感器参数
1. **加速度计数据**：
   | 参数 | 类型 | 单位 | 说明 |
   |------|------|------|------|
   | xacc | float | m/s/s | X轴加速度 |
   | yacc | float | m/s/s | Y轴加速度 |
   | zacc | float | m/s/s | Z轴加速度 |

2. **陀螺仪数据**：
   | 参数 | 类型 | 单位 | 说明 |
   |------|------|------|------|
   | xgyro | float | rad/s | X轴角速度 |
   | ygyro | float | rad/s | Y轴角速度 |
   | zgyro | float | rad/s | Z轴角速度 |

3. **磁力计数据**：
   | 参数 | 类型 | 单位 | 说明 |
   |------|------|------|------|
   | xmag | float | gauss | X轴磁场强度 |
   | ymag | float | gauss | Y轴磁场强度 |
   | zmag | float | gauss | Z轴磁场强度 |

### 气压相关参数
| 参数 | 类型 | 单位 | 说明 |
|------|------|------|------|
| abs_pressure | float | millibar | 绝对气压值 |
| diff_pressure | float | millibar | 差分气压值 |
| pressure_alt | float | meter | 气压高度 |
| temperature | float | 摄氏度 | 温度 |

### 状态参数
| 参数 | 类型 | 说明 |
|------|------|------|
| fields_updated | uint32_t | 更新标志位，表示哪些字段被更新 |

### 参数修改示例

1. **加速度攻击**：
```python
# 反转Z轴加速度
m.zacc = -m.zacc

# 添加X轴噪声
m.xacc += random.gauss(0, 0.5)

# 缩放Y轴加速度
m.yacc *= 1.5
```

2. **角速度攻击**：
```python
# 清零所有角速度
m.xgyro = 0
m.ygyro = 0
m.zgyro = 0

# 放大角速度
m.xgyro *= 2.0
```

3. **磁力计攻击**：
```python
# 添加磁场干扰
m.xmag += 0.5
m.ymag -= 0.5

# 反转磁场方向
m.zmag = -m.zmag
```

4. **气压攻击**：
```python
# 修改气压高度
m.pressure_alt += 10

# 改变温度
m.temperature += 5

# 修改气压值
m.abs_pressure *= 0.9
```

### 注意事项

1. **数值范围**：
   - 加速度：通常在 ±16g 范围内
   - 角速度：通常在 ±2000°/s 范围内
   - 磁场：通常在 ±4.8 Gauss 范围内
   - 气压：通常在 300-1100 hPa 范围内

2. **更新频率**：
   - IMU数据：250Hz
   - 气压数据：50Hz
   - 温度数据：1Hz

3. **攻击建议**：
   - 避免使用超出传感器量程的值
   - 考虑添加随机噪声而不是固定偏移
   - 可以组合多个参数进行攻击
   - 注意保持数据的物理相关性

## MAVProxy 数据流处理机制

MAVProxy 通过两个核心函数处理 MAVLink 数据包，使得攻击模块能够在数据传输的任何位置进行干预。

### 数据流向图

```
飞控 (Autopilot) <---> MAVProxy <---> 地面站 (GCS)
     ↑                    ↑               ↑
process_mavlink() <--> 模块处理 <--> process_master()
```

### 1. process_master 函数

**功能**：处理来自地面站的数据包（地面站 → 飞控）

**主要处理步骤**：

1. 数据接收：接收最多 16KB 的数据
2. 空数据处理：避免 CPU 空转
3. 更新字节计数器：记录数据流量
4. 原始数据日志：记录原始数据
5. MAVLink 版本检测：自动适应版本
6. 数据包解析：解析 MAVLink 消息
7. 错误处理：处理异常数据

**关键特点**：

- 直接处理和转发数据
- 无特殊权限控制
- 处理 BAD_DATA 错误
- 支持调试模式
- 维护数据统计

### 2. process_mavlink 函数

**功能**：处理来自飞控的数据包（飞控 → 地面站）

**主要处理步骤**：

1. 数据接收：从飞控接收数据
2. 版本检测：自动检测 MAVLink 版本
3. 数据解析：解析 MAVLink 消息
4. 权限检查：检查转发权限
5. 模块处理：调用模块的处理函数
6. 转发控制：选择合适的转发链路
7. 日志记录：记录处理后的数据
8. 监视功能：支持消息监视

**关键特点**：

- 支持模块介入处理
- 有 mavfwd 权限控制
- 智能链路选择
- 支持消息监视
- 处理 MAVError 错误

### 两个函数的主要区别

| 特性     | process_master | process_mavlink             |
| -------- | -------------- | --------------------------- |
| 数据流向 | 地面站 → 飞控 | 飞控 → 地面站              |
| 处理方式 | 直接处理和转发 | 经过模块处理后转发          |
| 权限控制 | 无特殊控制     | 有 mavfwd 权限控制          |
| 模块介入 | 不直接调用模块 | 调用模块的 mavlink_backward |
| 错误处理 | 处理 BAD_DATA  | 处理 MAVError               |

### 在攻击模块中的应用

1. **硬件后门攻击**：

   - 通过 process_master 拦截和修改控制命令
   - 影响执行器的实际控制输出
2. **传感器攻击**：

   - 通过 process_mavlink 修改传感器数据
   - 影响飞控的状态估计
3. **GPS 欺骗**：

   - 通过 process_mavlink 修改位置信息
   - 干扰导航系统
4. **速度反转**：

   - 通过 process_mavlink 修改速度命令
   - 影响运动控制

### 安全影响

1. **数据完整性**：

   - 可以修改任何 MAVLink 消息
   - 影响系统的正常运行
2. **系统控制**：

   - 可以劫持控制命令
   - 可以注入虚假数据
3. **状态监控**：

   - 可以欺骗监控系统
   - 隐藏真实状态

### 防护建议

1. **通信加密**：

   - 使用加密通信链路
   - 实施消息签名机制
2. **权限控制**：

   - 严格控制转发权限
   - 实施访问控制
3. **数据验证**：

   - 验证数据的合理性
   - 检测异常模式
4. **监控告警**：

   - 实时监控数据流
   - 设置异常告警机制

## 注意事项

1. 这些攻击功能仅用于安全研究和测试目的
2. 在实际飞行器上测试这些攻击可能导致危险情况
3. 建议在仿真环境中进行测试
4. 使用这些功能时需要充分了解可能的风险

## 实现原理

模块通过两个主要的数据包处理函数实现攻击：

1. `mavlink_packet(self, m, mav)`: 处理来自主链路的MAVLink数据包
2. `mavlink_backward(self, m, mav)`: 处理来自从链路的MAVLink数据包

每种攻击都可以通过命令单独开启或关闭，实现了对无人机各个子系统的针对性攻击：

- 控制系统（硬件后门、速度反转）
- 导航系统（GPS欺骗）
- 任务规划（消息修改）
- 传感器系统（传感器修改和注入）
- 地面站显示（GCS欺骗）
